

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Code Property Graph Tutorial &mdash; MATE 0.1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/mystnb.css" type="text/css" />
  <link rel="stylesheet" href="_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_paramlinks.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Flowfinder Tutorial" href="tutorial-flowfinder.html" />
    <link rel="prev" title="UI Walkthrough" href="ui-walkthrough.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> MATE
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="ui-walkthrough.html">UI Walkthrough</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Code Property Graph Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#guessing-game-example-program">Guessing Game example program</a></li>
<li class="toctree-l2"><a class="reference internal" href="#llvm-bitcode-representation">LLVM bitcode representation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bitcode-for-the-print-guesses-function">Bitcode for the <code class="docutils literal notranslate"><span class="pre">print_guesses</span></code> function</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#guessing-game-cpg">Guessing game CPG</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cpg-data-model">CPG data model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-queries">Simple queries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#call-graph-cg">Call Graph (CG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#abstract-syntax-tree-ast">Abstract Syntax Tree (AST)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#control-flow-graph-cfg">Control-Flow Graph (CFG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#control-dependence-graph-cdg">Control-Dependence Graph (CDG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-flow-graph-dfg">Data-Flow Graph (DFG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inter-procedural-data-flow">Inter-procedural data-flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#information-flow-graph-ifg">Information-Flow Graph (IFG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#points-to-graph-ptg">Points-To Graph (PTG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inter-procedural-control-flow-graph-icfg">Inter-procedural Control-Flow Graph (ICFG)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#understanding-function-call-subgraphs">Understanding function call subgraphs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#query-language-tips-and-tricks">Query language tips and tricks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#corrupted-cpg-session">Corrupted cpg session</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exercises">Exercises</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#exercise-1">Exercise 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-2">Exercise 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-3">Exercise 3</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial-flowfinder.html">Flowfinder Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial-notebooks.html">Notebook Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command-Line Tools Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli-overview.html">CLI Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpg.html">The Code Property Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging-builds.html">Debugging Program Build Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="dwarfcore.html">Dwarfcore</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">Environment variables in the MATE container</a></li>
<li class="toctree-l1"><a class="reference internal" href="mantiserve.html">Mantiserve</a></li>
<li class="toctree-l1"><a class="reference internal" href="pois.html">Points of Interest</a></li>
<li class="toctree-l1"><a class="reference internal" href="schemata/cpg.html">CPG Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="signatures.html">MATE Signatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="trace.html">Traces</a></li>
<li class="toctree-l1"><a class="reference internal" href="under-constrained-manticore.html">Under-constrained Manticore</a></li>
<li class="toctree-l1"><a class="reference internal" href="usagefinder.html">UsageFinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-flowfinder.html">Using Flowfinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-notebooks.html">MATE Python Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-rest-api.html">Using the REST API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">MATE API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference external" href="api.html#http://">MATE REST API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hacking.html">Hacking on MATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="legal.html">Legal</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Writing and running MATE’s tests</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MATE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Code Property Graph Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/tutorial-cpg.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="code-property-graph-tutorial">
<h1>Code Property Graph Tutorial<a class="headerlink" href="#code-property-graph-tutorial" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p><strong>Note:</strong> This tutorial is available <a class="reference external" href="https://galoisinc.github.io/MATE/cpg-tutorial-no-solutions.html">as a webpage</a> or as a Jupyter notebook in a running MATE system. If you view this tutorial on the web, you won’t be able to see the output of the code blocks. To access this tutorial from a running MATE system, navigate to the web UI (usually http://localhost:3000), click “For experts”, “Notebooks”, “examples/”, and “cpg-tutorial-no-solutions.ipynb”.</p>
</div></blockquote>
<p>At the core of MATE is a representation of the target program as a “code property graph.” A code property graph (CPG) is an annotated graph data structure that unifies the results of many different analyses of a target program, including its:</p>
<ul class="simple">
<li><p>abstract syntax tree (AST)</p></li>
<li><p>call graph (CG)</p></li>
<li><p>control-flow graph (CFG)</p></li>
<li><p>inter-procedural control-flow graph (ICFG)</p></li>
<li><p>dataflow-graph (DFG)</p></li>
<li><p>control-dependence graph (CDG)</p></li>
<li><p>points-to graph (PTG)</p></li>
</ul>
<p>Combining these representations in a single graph makes it possible to write queries over the graph that reason about the structure and behavior of the program and discover potential vulnerabilities.</p>
<p>This tutorial will introduce the elements of the code property graph while demonstrating how to use MATE’s CPG query language.</p>
<blockquote>
<div><p><strong>Note:</strong> A number of important query language concepts and tips are discussed along the way, so we encourage reading the entire tutorial, paying particular attention to notes like this one.</p>
</div></blockquote>
<div class="section" id="guessing-game-example-program">
<h2>Guessing Game example program<a class="headerlink" href="#guessing-game-example-program" title="Permalink to this headline">¶</a></h2>
<p>To understand the components of the CPG, we examine a simple C program that implements a guessing game. You can access the source code of the challenge in the <span class="xref myst">assets</span> directory: <span class="xref myst">assets/guessing-game.c</span>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">main</span></code> function of the program initializes a “secret” number stored in a global variable to a randomly chosen number between 1 and 10. The user is then prompted to guess the number up to 10 times. If the user guesses correctly, the program prints “You win!” and the value of the secret number. If the user guesses incorrectly, the list of all of their guesses so far is printed and they are asked to try again. If the user does not guess correctly in 10 tries, the program exits.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">secret</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">secret_t</span><span class="p">;</span><span class="w"></span>

<span class="n">secret_t</span><span class="w"> </span><span class="n">hidden</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">get_guess</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">guess</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">print_guesses</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">guesses</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">hidden</span><span class="p">.</span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">guesses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">get_guess</span><span class="p">(</span><span class="o">&amp;</span><span class="n">guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w"> </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hidden</span><span class="p">.</span><span class="n">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;You win! the secret was %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hidden</span><span class="p">.</span><span class="n">number</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">free</span><span class="p">(</span><span class="n">guesses</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Wrong answer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">print_guesses</span><span class="p">(</span><span class="n">guesses</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;You&#39;re out of guesses, sorry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">guesses</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_guess</span></code> function is implemented using a helper function <code class="docutils literal notranslate"><span class="pre">read_num</span></code> that uses the C standard library function <code class="docutils literal notranslate"><span class="pre">scanf</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">read_num</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">no</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">num</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">num</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">get_guess</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">guess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Guess a number 1-10: &quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_num</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid entry. Try again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The print_guesses function takes a pointer to the start of the <code class="docutils literal notranslate"><span class="pre">guesses</span></code> array and prints all of the guesses up to and including the guess at index <code class="docutils literal notranslate"><span class="pre">i</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">print_guesses</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">guesses</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Your guesses so far:&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">guesses</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="llvm-bitcode-representation">
<h2>LLVM bitcode representation<a class="headerlink" href="#llvm-bitcode-representation" title="Permalink to this headline">¶</a></h2>
<p>MATE does not analyze C or C++ source code directly, but instead first compiles programs to LLVM bitcode, a low-level, procedural intermediatere presentation used by the LLVM compiler infrastructure. Analyzing bitcode directly allows MATE to process any language that compiles using LLVM and simplifies the number of coding constructs the system must understand.</p>
<p>The LLVM bitcode language is detailed in the <a class="reference external" href="https://releases.llvm.org/7.0.0/docs/LangRef.html">LLVM Language Reference Manual</a> accompanying the LLVM compiler. Consider taking some time to familiarize yourself with the language, particularly the <a class="reference external" href="https://releases.llvm.org/7.0.0/docs/LangRef.html#instruction-reference">Instruction Reference</a>.</p>
<p>While building a program’s CPG, MATE generates a “canonical” bitcode file linking all of the modules compiled into the program. In the CHESS system, this file can be viewed in the “Vision” tool by selecting the file with the suffix “.canonical.ll”.</p>
<p>For this tutorial, you can view the bitcode of the guessing-game program in the <span class="xref myst">assets</span> directory: <span class="xref myst">assets/guessing-game.ll</span>. The bitcode of the program and other intermediate artifacts can be also be downloaded using the <code class="docutils literal notranslate"><span class="pre">mate-cli</span></code> command line tool or the MATE REST API.</p>
<div class="section" id="bitcode-for-the-print-guesses-function">
<h3>Bitcode for the <code class="docutils literal notranslate"><span class="pre">print_guesses</span></code> function<a class="headerlink" href="#bitcode-for-the-print-guesses-function" title="Permalink to this headline">¶</a></h3>
<p>To get a feel for the translation of C code to bitcode, consider the <code class="docutils literal notranslate"><span class="pre">print_guesses</span></code> function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">print_guesses</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">guesses</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Your guesses so far:&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">guesses</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This function compiles to the following bitcode:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="vg">@.str.6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="k">constant</span><span class="w"> </span><span class="p">[</span><span class="m">21</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="k">c</span><span class="s">&quot;Your guesses so far:\00&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="vg">@.str.7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="k">constant</span><span class="w"> </span><span class="p">[</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="k">c</span><span class="s">&quot; %d\00&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="w"></span>
<span class="vg">@.str.8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="k">constant</span><span class="w"> </span><span class="p">[</span><span class="m">2</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="k">c</span><span class="s">&quot;\0A\00&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="w"></span>

<span class="c">; Function Attrs: noinline nounwind optnone uwtable</span>
<span class="k">define</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@print_guesses</span><span class="p">(</span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!84</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">i0:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">**</span><span class="w"> </span><span class="nv">%t0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w"></span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.dbg.declare</span><span class="p">(</span><span class="k">metadata</span><span class="w"> </span><span class="kt">i32</span><span class="p">**</span><span class="w"> </span><span class="nv">%t0</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv nv-Anonymous">!87</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv">!DIExpression</span><span class="p">()),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!88</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t1</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="w"></span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.dbg.declare</span><span class="p">(</span><span class="k">metadata</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t1</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv nv-Anonymous">!89</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv">!DIExpression</span><span class="p">()),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!90</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="vg">@printf</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="p">([</span><span class="m">21</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">21</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]*</span><span class="w"> </span><span class="vg">@.str.6</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!91</span><span class="w"></span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.dbg.declare</span><span class="p">(</span><span class="k">metadata</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t2</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv nv-Anonymous">!92</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv">!DIExpression</span><span class="p">()),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!94</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!94</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!95</span><span class="w"></span>

<span class="nl">i1:</span><span class="w">                                               </span><span class="c">; preds = %i3, %i0</span>
<span class="w">  </span><span class="nv">%t4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!96</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t1</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!98</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t6</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">sle</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t4</span><span class="p">,</span><span class="w"> </span><span class="nv">%t5</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!99</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%t6</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i2</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!100</span><span class="w"></span>

<span class="nl">i2:</span><span class="w">                                               </span><span class="c">; preds = %i1</span>
<span class="w">  </span><span class="nv">%t7</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">**</span><span class="w"> </span><span class="nv">%t0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!101</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t8</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!103</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t9</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">sext</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t8</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!101</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t10</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t7</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%t9</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!101</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t11</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t10</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!101</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t12</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="vg">@printf</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="p">([</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]*</span><span class="w"> </span><span class="vg">@.str.7</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t11</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!104</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i3</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!105</span><span class="w"></span>

<span class="nl">i3:</span><span class="w">                                               </span><span class="c">; preds = %i2</span>
<span class="w">  </span><span class="nv">%t13</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!106</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t14</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">nsw</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t13</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!106</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t14</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!106</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!107</span><span class="p">,</span><span class="w"> </span><span class="nv">!llvm.loop</span><span class="w"> </span><span class="nv nv-Anonymous">!108</span><span class="w"></span>

<span class="nl">i4:</span><span class="w">                                               </span><span class="c">; preds = %i1</span>
<span class="w">  </span><span class="nv">%t15</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="vg">@printf</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="p">([</span><span class="m">2</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">2</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]*</span><span class="w"> </span><span class="vg">@.str.8</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!110</span><span class="w"></span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!111</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Some things to note:</p>
<ul class="simple">
<li><p>LLVM bitcode has <em>unstructured</em> control-flow: constructs such as <code class="docutils literal notranslate"><span class="pre">if</span></code> statements and <code class="docutils literal notranslate"><span class="pre">loops</span></code> are compiled to sets of <em>basic blocks</em> (unconditionally executed sequences of instructions) with labels (e.g. <code class="docutils literal notranslate"><span class="pre">i0</span></code>, <code class="docutils literal notranslate"><span class="pre">i1</span></code>, …) connected by explicit branches.</p></li>
<li><p>Complex expressions that might involve multiple arithmetic operations or loads or stores to memory are decomposed into sequences of simple instructions such as <code class="docutils literal notranslate"><span class="pre">load</span></code>, <code class="docutils literal notranslate"><span class="pre">store</span></code>, or <code class="docutils literal notranslate"><span class="pre">add</span></code>.</p></li>
<li><p>Stack allocations are explicit via calls to the <code class="docutils literal notranslate"><span class="pre">alloca</span></code> instruction (though at higher optimization levels they are frequently compiled away).</p></li>
<li><p>The code is in <em>static single assignment</em> (SSA) form: each variable has a single definition and only values explicitly stored in memory locations may be directly mutated. Places where loops or other control structures mean that multiple dynamic occurences of a definition could reach the same instruction, explicit <a class="reference external" href="https://releases.llvm.org/7.0.0/docs/LangRef.html#i-phi">phi instructions</a> are introduced to track the dependencies.</p></li>
<li><p>The bitcode includes a number of elements for tracking debug information relating back to the original source code of the program, including directives such as <code class="docutils literal notranslate"><span class="pre">!dbg</span> <span class="pre">!71</span></code> and calls to debugging intrinsics, such as <code class="docutils literal notranslate"><span class="pre">&#64;llvm.dbg.declare</span></code>, which will be converted into DWARF debugging information embedded in the compiled binary.</p></li>
</ul>
</div>
</div>
<div class="section" id="guessing-game-cpg">
<h2>Guessing game CPG<a class="headerlink" href="#guessing-game-cpg" title="Permalink to this headline">¶</a></h2>
<p>Let’s take an initial look at the CPG for the guessing game program. You can load a CPG in the MATE notebook service by creating a new database session and then invoking <code class="docutils literal notranslate"><span class="pre">session.graph_from_build()</span></code> with the build UUID of the target CPG (available from the MATE builds page). Clicking on an “Open Jupyter Notebook” button will open a notebook prepopulated with the necessary commands to start querying the corresponding database.</p>
<p>Here, the tutorial queries the MATE databse to determine which CPG to load.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mate_common.models.artifacts</span> <span class="kn">import</span> <span class="n">ArtifactKind</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">new_session</span><span class="p">()</span>

<span class="n">build</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Build</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Artifact</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Build</span><span class="o">.</span><span class="n">artifacts</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">ArtifactKind</span><span class="o">.</span><span class="n">CompileOutputBitcode</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;binary_filename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">==</span> <span class="s2">&quot;guessing-game.bin&quot;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Build</span><span class="p">)</span>
    <span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">build</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">[31mPlease build a CPG for the guess-game.c program before continuing.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You can build the CPG using the `mate-cli` command line tool by downloading&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;`guessing-game.c` and then running the command `mate-cli oneshot guessing-game.c.`&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You may need to supply a connection string argument to `mate-cli` depending on&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;your network and MATE configuration.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Once you have built a CPG for the guessing game, please run this cell again.</span><span class="se">\x1b</span><span class="s2">[0m&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">cpg</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">graph_from_build</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With the CPG connected to the notebook, let’s start exploring the CPG with some graph visualizations. The following cell implements a graphviz-based visualization function that takes as input queries defining the nodes and edges to visualize, along with options for configuring the output.</p>
<p>It is very complex and you don’t need to understand it to complete the tutorial—just run the block to make the definitions available in the cells that follow. In the future, you might find this code useful to re-use or modify when writing your own CPG exploration tools.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Final</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">import</span> <span class="nn">pygraphviz</span> <span class="k">as</span> <span class="nn">pgv</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">aliased</span>

<span class="kn">from</span> <span class="nn">mate_common.models.cpg_types</span> <span class="kn">import</span> <span class="n">EdgeKind</span><span class="p">,</span> <span class="n">MATEComponent</span><span class="p">,</span> <span class="n">NodeJSON</span><span class="p">,</span> <span class="n">NodeKind</span>
<span class="kn">from</span> <span class="nn">mate_common.models.cpg_types.mate</span> <span class="kn">import</span> <span class="n">CONSTANT_NODES</span><span class="p">,</span> <span class="n">DWARF_TYPE_NODES</span><span class="p">,</span> <span class="n">INSTRUCTION_NODES</span><span class="p">,</span> <span class="n">POINTS_TO</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mate.cpg.models.core</span> <span class="kn">import</span> <span class="n">CPG</span><span class="p">,</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">Node</span>
    <span class="kn">from</span> <span class="nn">mate.cpg.models.node.ast.llvm</span> <span class="kn">import</span> <span class="n">Block</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> <span class="n">Instruction</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;MATE&quot;</span><span class="p">)</span>

<span class="c1"># NOTE(ww): The color names here and below are X11 color names;</span>
<span class="c1"># they&#39;re what Graphviz uses internally.</span>
<span class="n">COMPONENT_COLOR_MAP</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">MATEComponent</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">MATEComponent</span><span class="o">.</span><span class="n">AST_GRAPH_WRITER</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="n">MATEComponent</span><span class="o">.</span><span class="n">HEADACHE</span><span class="p">:</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span>
    <span class="n">MATEComponent</span><span class="o">.</span><span class="n">ASPIRIN</span><span class="p">:</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span>
    <span class="n">MATEComponent</span><span class="o">.</span><span class="n">WEDLOCK</span><span class="p">:</span> <span class="s2">&quot;aquamarine&quot;</span><span class="p">,</span>
    <span class="n">MATEComponent</span><span class="o">.</span><span class="n">SIGNATURE</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">VizStrategy</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enumerates the set of strategies understood by Visualizer.&quot;&quot;&quot;</span>

    <span class="n">NAIVE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;naive&quot;</span>
    <span class="n">IR_SUBGRAPHS</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ir-subgraphs&quot;</span>

    <span class="c1"># TODO(ww): Implement this visualization strategies.</span>
    <span class="c1"># ASM_SUBGRAPHS = &quot;asm-subgraphs&quot;</span>
    <span class="c1"># CALLGRAPH = &quot;callgraph&quot;</span>
    <span class="c1"># DATAFLOW = &quot;dataflow&quot;</span>

    <span class="c1"># NOTE(ww): We define this so that argparse can convert each enum</span>
    <span class="c1"># into a nice value for its --help output.</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">VizStyle</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enumerates the set of strategies understood by Visualizer.&quot;&quot;&quot;</span>

    <span class="n">DETAIL</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;detail&quot;</span>
    <span class="n">PROVENANCE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;provenance&quot;</span>

    <span class="c1"># NOTE(ww): We define this so that argparse can convert each enum</span>
    <span class="c1"># into a nice value for its --help output.</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">VizProgram</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enumerates the layout programs that can be specified for graphviz.&quot;&quot;&quot;</span>

    <span class="n">DOT</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dot&quot;</span>
    <span class="n">NEATO</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;neato&quot;</span>

    <span class="c1"># NOTE(ww): We define this so that argparse can convert each enum</span>
    <span class="c1"># into a nice value for its --help output.</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="k">def</span> <span class="nf">_add_node_tracked</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">,</span> <span class="n">stylefunc</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Node</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">visited</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="c1"># NOTE(ww): We could use the URL attribute here to link to the node&#39;s documentation.</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="o">**</span><span class="n">stylefunc</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_add_edge_tracked</span><span class="p">(</span><span class="n">graph</span><span class="p">:</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Edge</span><span class="p">,</span> <span class="n">visited</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">uuid</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="c1"># NOTE(ww): We could use labelURL here to link to the edge&#39;s documentation.</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
        <span class="n">edge</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
        <span class="n">edge</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">lhead</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">ltail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">edge</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">StyleKeyword</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">LABEL</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span>
    <span class="n">SHAPE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;shape&quot;</span>
    <span class="n">COLOR</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span>
    <span class="n">STYLE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;style&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="k">def</span> <span class="nf">_style_by_provenance</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">COMPONENT_COLOR_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">provenance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No color configured for </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">; defaulting to gray&quot;</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="n">StyleKeyword</span><span class="o">.</span><span class="n">LABEL</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
        <span class="n">StyleKeyword</span><span class="o">.</span><span class="n">COLOR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
        <span class="n">StyleKeyword</span><span class="o">.</span><span class="n">STYLE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="s2">&quot;filled&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_label_uuid</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_make_label_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">:</span> <span class="n">NodeJSON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Node</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">_label_attribute</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">_label_attribute</span>


<span class="k">def</span> <span class="nf">_label_function</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">demangled</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;demangled&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">demangled</span>
        <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">demangled</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_label_instruction</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;pretty_string&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;pretty_string&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;ssa_name&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;ssa_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;opcode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;opcode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_label_constant</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;pretty_string&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;pretty_string&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;constant_int_value&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;constant_int_value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_label_llvm_type</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;pretty_string&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;definition&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;definition&#39;</span><span class="p">][</span><span class="s1">&#39;pretty_string&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_label_param_binding</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: parameter binding for argument </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;arg_op_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_label_machine_instr</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;pretty_string&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;pretty_string&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;opcode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span> <span class="nc">DetailColors</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CODE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
    <span class="n">DATA</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
    <span class="n">MEM</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
    <span class="n">TYPE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
    <span class="n">MODEL</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;purple&quot;</span>
    <span class="n">UNKNOWN</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>


<span class="k">class</span> <span class="nc">DetailShapes</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CODE</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span>
    <span class="n">DATA</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span>
    <span class="n">LOWLEVEL</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;trapezium&quot;</span>
    <span class="n">LOC</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;oval&quot;</span>
    <span class="n">RIGHT</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rarrow&quot;</span>
    <span class="n">LEFT</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;larrow&quot;</span>
    <span class="n">HEX</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hexagon&quot;</span>


<span class="n">NODE_KIND_COLOR_MAP</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeKind</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">DATA</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONSTANT_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">TYPE</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DWARF_TYPE_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DWARF_FEATURE_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">INSTRUCTION_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MODULE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">TRANSLATION_UNIT</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">FUNCTION</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">BLOCK</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MEMORY_LOCATION</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MEM</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">UNCLASSIFIED_NODE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">LLVM_TYPE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">TYPE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ARGUMENT</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">DATA</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">LOCAL_VARIABLE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MEM</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">GLOBAL_VARIABLE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MEM</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">PARAM_BINDING</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">CALL_RETURN</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_GLOBAL_VARIABLE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MEM</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_BASIC_BLOCK</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_FUNCTION</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_INSTR</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_BLOCK</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_INST</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">DATAFLOW_SIGNATURE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">INPUT_SIGNATURE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">OUTPUT_SIGNATURE</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">PLT_STUB</span><span class="p">:</span> <span class="n">DetailColors</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">NODE_KIND_SHAPE_MAP</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeKind</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">DATA</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONSTANT_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DWARF_TYPE_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DWARF_FEATURE_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">INSTRUCTION_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MODULE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">TRANSLATION_UNIT</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">FUNCTION</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">BLOCK</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MEMORY_LOCATION</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">UNCLASSIFIED_NODE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">LLVM_TYPE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">CODE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ARGUMENT</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">DATA</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">LOCAL_VARIABLE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">DATA</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">GLOBAL_VARIABLE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">DATA</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">PARAM_BINDING</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">RIGHT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">CALL_RETURN</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LEFT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_GLOBAL_VARIABLE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_BASIC_BLOCK</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_FUNCTION</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_INSTR</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_BLOCK</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_INST</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">DATAFLOW_SIGNATURE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">HEX</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">INPUT_SIGNATURE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">RIGHT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">OUTPUT_SIGNATURE</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LEFT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">PLT_STUB</span><span class="p">:</span> <span class="n">DetailShapes</span><span class="o">.</span><span class="n">LOWLEVEL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">NODE_KIND_LABEL_MAP</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeKind</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Node</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_label_constant</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONSTANT_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_label_uuid</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DWARF_TYPE_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_label_uuid</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">DWARF_FEATURE_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_label_instruction</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">INSTRUCTION_NODES</span><span class="p">},</span>
    <span class="o">**</span><span class="p">{</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MODULE</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">MODULE_NAME</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">TRANSLATION_UNIT</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">FILENAME</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">FUNCTION</span><span class="p">:</span> <span class="n">_label_function</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">BLOCK</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">CONSTANT_STRING</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">STRING_VALUE</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MEMORY_LOCATION</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">PRETTY_STRING</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">UNCLASSIFIED_NODE</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">LLVM_TYPE</span><span class="p">:</span> <span class="n">_label_llvm_type</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ARGUMENT</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">NAME</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">LOCAL_VARIABLE</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">NAME</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">GLOBAL_VARIABLE</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">NAME</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">PARAM_BINDING</span><span class="p">:</span> <span class="n">_label_param_binding</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">CALL_RETURN</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_GLOBAL_VARIABLE</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">NAME</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_BASIC_BLOCK</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">SYMBOL</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_FUNCTION</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">NAME</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">MACHINE_INSTR</span><span class="p">:</span> <span class="n">_label_machine_instr</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_BLOCK</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">ASM_INST</span><span class="p">:</span> <span class="n">_make_label_attribute</span><span class="p">(</span><span class="n">NodeJSON</span><span class="o">.</span><span class="n">PRETTY_STRING</span><span class="p">),</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">DATAFLOW_SIGNATURE</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">INPUT_SIGNATURE</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">OUTPUT_SIGNATURE</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
        <span class="n">NodeKind</span><span class="o">.</span><span class="n">PLT_STUB</span><span class="p">:</span> <span class="n">_label_uuid</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_style_by_detail</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">StyleKeyword</span><span class="o">.</span><span class="n">SHAPE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">NODE_KIND_SHAPE_MAP</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="p">],</span>
        <span class="n">StyleKeyword</span><span class="o">.</span><span class="n">COLOR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">NODE_KIND_COLOR_MAP</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="p">],</span>
        <span class="n">StyleKeyword</span><span class="o">.</span><span class="n">LABEL</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">NODE_KIND_LABEL_MAP</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="p">](</span><span class="n">node</span><span class="p">),</span>
    <span class="p">}</span>


<span class="k">class</span> <span class="nc">Visualizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Visualizes the supplied CPG using Graphviz.</span>

<span class="sd">    Supports filters for restricting the kinds of nodes visualized, as well as a set of</span>
<span class="sd">    visualization &quot;strategies&quot; for laying the CPG out with a particular set of features in mind.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpg</span><span class="p">:</span> <span class="n">CPG</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span> <span class="o">=</span> <span class="n">cpg</span>

    <span class="k">def</span> <span class="nf">_dispatch_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">graph_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="n">VizStyle</span><span class="o">.</span><span class="n">PROVENANCE</span><span class="p">:</span>
            <span class="n">style_fun</span> <span class="o">=</span> <span class="n">_style_by_provenance</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="n">VizStyle</span><span class="o">.</span><span class="n">DETAIL</span><span class="p">:</span>
            <span class="n">style_fun</span> <span class="o">=</span> <span class="n">_style_by_detail</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unimplemented strategy: </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unimplemented strategy: </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="n">VizStrategy</span><span class="o">.</span><span class="n">NAIVE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_naive</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">graph_kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="n">VizStrategy</span><span class="o">.</span><span class="n">IR_SUBGRAPHS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_ir_subgraphs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">graph_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unimplemented style: </span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unimplemented style: </span><span class="si">{</span><span class="n">style</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_render_naive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">graph_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;A &quot;naive&quot; rendering strategy, where we iterate over every edge in some arbitrary</span>
<span class="sd">        (probably insertion) order and hope for a relatively readable output graph.</span>

<span class="sd">        Pros: Fast.</span>
<span class="sd">        Cons: No clustering or subgraph identification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">(</span><span class="n">directed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">graph_kwargs</span><span class="p">)</span>

        <span class="n">visited_nodes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">[</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_nodes</span><span class="p">:</span>
                    <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="o">**</span><span class="n">style_fun</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">visited_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">source</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">uuid</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="nf">_render_ir_subgraphs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">graph_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;A subgraph rendering strategy, where IR functions (and their constituent blocks +</span>
<span class="sd">        instructions) are collected into discrete subgraphs.</span>

<span class="sd">        Pros: Fast-ish, puts functions and their features in distinct subgraphs.</span>
<span class="sd">        Cons: Not much easier to read than the &quot;naive&quot; strategy, does funny things</span>
<span class="sd">              when a subgraph has no blocks or instructions</span>
<span class="sd">              (e.g., an external or intrinsic function).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">pgv</span><span class="o">.</span><span class="n">AGraph</span><span class="p">(</span><span class="n">directed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compound</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">graph_kwargs</span><span class="p">)</span>

        <span class="n">visited_nodes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">visited_edges</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># This strategy has two passes:</span>
        <span class="c1"># 1. We build our subgraphs using a separate query, keeping track of seen nodes.</span>
        <span class="c1"># 2. We perform the main edge iteration, ignoring work already done by the subgraph pass.</span>
        <span class="n">node_uuids</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># Get the nodes that will be drawn by the visualization</span>
            <span class="n">query</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
            <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Block</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>

        <span class="n">func_query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">node_uuids</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">parent_function</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
            <span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">node_uuids</span><span class="p">))</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">I</span><span class="o">.</span><span class="n">parent_block</span><span class="p">)</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">parent_function</span><span class="p">)</span>
                <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">func_query</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">subgraph</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_subgraph</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subgraph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">subgraph</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">add_subgraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_style_by_detail</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>

            <span class="c1"># The subgraph gets the function itself, all of the function&#39;s basic blocks,</span>
            <span class="c1"># and each basic block&#39;s instructions (unless the latter has been filtered).</span>
            <span class="n">_add_node_tracked</span><span class="p">(</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">visited_nodes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                <span class="n">blockgraph</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">get_subgraph</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">blockgraph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">blockgraph</span> <span class="o">=</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">add_subgraph</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">block</span><span class="o">.</span><span class="n">uuid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_style_by_detail</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">_add_node_tracked</span><span class="p">(</span><span class="n">blockgraph</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">visited_nodes</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">instructions</span><span class="p">:</span>
                    <span class="n">_add_node_tracked</span><span class="p">(</span><span class="n">blockgraph</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">visited_nodes</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">EdgeKind</span><span class="o">.</span><span class="n">INSTRUCTION_TO_PARENT_BLOCK</span><span class="p">,</span>
                <span class="n">EdgeKind</span><span class="o">.</span><span class="n">BLOCK_TO_PARENT_FUNCTION</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">[</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">]:</span>
                <span class="n">_add_node_tracked</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">style_fun</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">visited_nodes</span><span class="p">)</span>

            <span class="n">_add_edge_tracked</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">visited_edges</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">graph</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">node_query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Query</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">node_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Node</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Query</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Edge</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="n">VizStrategy</span><span class="o">.</span><span class="n">NAIVE</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">VizStyle</span><span class="o">.</span><span class="n">DETAIL</span><span class="p">,</span>
        <span class="o">**</span><span class="n">graph_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Renders the CPG with Graphviz using the supplied options, yielding a</span>
<span class="sd">        ``pygraphviz.AGraph`` object.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">node_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Node</span>

        <span class="k">if</span> <span class="n">edge_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Edge</span>

        <span class="n">Source</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span>
        <span class="n">Target</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node_query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge_query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">edge_class</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Source</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Target</span><span class="p">,</span> <span class="n">Target</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">edge_class</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Target</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">edge_query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Source</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Target</span><span class="p">,</span> <span class="n">Target</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">edge_class</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Target</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_subquery</span> <span class="o">=</span> <span class="n">node_query</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">node_class</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">edge_query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">edge_class</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="p">(</span><span class="n">Source</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Source</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">node_subquery</span><span class="p">)))</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Target</span><span class="p">,</span> <span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">node_subquery</span><span class="p">)))</span>
                    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">edge_class</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Target</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">edge_query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">Source</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">Source</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Source</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">node_subquery</span><span class="p">)),</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">Target</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">edge_class</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Target</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">node_subquery</span><span class="p">)),</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">edge_class</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Target</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># NOTE(ww): 5000 is somewhat arbitrary here.</span>
        <span class="n">edge_count</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">edge_count</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Given a large CPG; consider filtering some nodes&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rendering CPG with </span><span class="si">{</span><span class="n">edge_count</span><span class="si">}</span><span class="s2"> edges&quot;</span><span class="p">)</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">graph_kwargs</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">graph</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">display_cpg</span><span class="p">(</span>
    <span class="n">cpg</span><span class="p">,</span>
    <span class="n">node_query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Query</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">node_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Node</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">edge_query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Query</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">edge_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Edge</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="n">VizStrategy</span><span class="o">.</span><span class="n">NAIVE</span><span class="p">,</span>
    <span class="n">style</span><span class="o">=</span><span class="n">VizStyle</span><span class="o">.</span><span class="n">DETAIL</span><span class="p">,</span>
    <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">,</span>
    <span class="n">unconfined</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overlap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Displays a visualization of the CPG or query within a notebook.</span>

<span class="sd">    :param cpg: The CPG to visualize</span>
<span class="sd">    :param node_query: A query returning Nodes to include in the visualization</span>
<span class="sd">    :param node_class: Optional, the model class for which node_query will return results, required if node_query uses an aliased model class</span>
<span class="sd">    :param edge_query: A query returning Edges to include in the visualization</span>
<span class="sd">    :param edge_class: Optional, the model class for which edge_query will return results, required if node_query uses an aliased model class</span>
<span class="sd">    :param VizStrategy strategy: A layout strategy for grouping CPG nodes</span>
<span class="sd">    :param VizStyle style: A style for rendering CPG nodes</span>
<span class="sd">    :param VizProgram program: The program to use for rendering, e.g. &#39;dot&#39; or &#39;neato&#39;</span>
<span class="sd">    :param bool unconfined: If True, renders the visualization with scrollbars</span>
<span class="sd">    :param bool overlap: Whether to allow overlapping nodes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span><span class="n">cpg</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.png&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="c1"># Hide warnings from implementation of IR_SUBGRAPH clusters, sizes, etc.</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">v</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">node_query</span><span class="o">=</span><span class="n">node_query</span><span class="p">,</span>
                <span class="n">node_class</span><span class="o">=</span><span class="n">node_class</span><span class="p">,</span>
                <span class="n">edge_query</span><span class="o">=</span><span class="n">edge_query</span><span class="p">,</span>
                <span class="n">edge_class</span><span class="o">=</span><span class="n">edge_class</span><span class="p">,</span>
                <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
                <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="n">program</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">unconfined</span><span class="o">=</span><span class="n">unconfined</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">uuids_for_function</span><span class="p">(</span><span class="n">cpg</span><span class="p">:</span> <span class="n">CPG</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">Inst</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">)</span>
    <span class="n">Blk</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Block</span><span class="p">)</span>
    <span class="n">Fun</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>

    <span class="c1"># Start by getting all of the Function, Block, and Instruction</span>
    <span class="c1"># nodes associated with the function.</span>
    <span class="n">in_func</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Fun</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">Fun</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="n">cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Blk</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Fun</span><span class="p">,</span> <span class="n">Blk</span><span class="o">.</span><span class="n">parent_function</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Fun</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">Blk</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span>
            <span class="n">cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Inst</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Blk</span><span class="p">,</span> <span class="n">Inst</span><span class="o">.</span><span class="n">parent_block</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Fun</span><span class="p">,</span> <span class="n">Blk</span><span class="o">.</span><span class="n">parent_function</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Fun</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">Inst</span><span class="o">.</span><span class="n">uuid</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Then add any node that&#39;s connected to these by an edge</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">in_func</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">in_func</span><span class="p">),</span>
            <span class="c1"># Don&#39;t follow outgoing CALL_RETURN_TO_CALLER, CALLGRAPH,</span>
            <span class="c1"># and VALUE_DEFINITION_TO_USE edges because they will</span>
            <span class="c1"># return nodes that aren&#39;t immediately relevant, such as</span>
            <span class="c1"># functions nodes invoked by the program</span>
            <span class="o">~</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">EdgeKind</span><span class="o">.</span><span class="n">CALL_RETURN_TO_CALLER</span><span class="p">,</span>
                    <span class="n">EdgeKind</span><span class="o">.</span><span class="n">CALLGRAPH</span><span class="p">,</span>
                    <span class="n">EdgeKind</span><span class="o">.</span><span class="n">VALUE_DEFINITION_TO_USE</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="c1"># Don&#39;t add nodes for machine inst or asmlevel</span>
            <span class="c1"># relationships</span>
            <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target_node</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">LLVM_LEVEL_NODES</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">in_func</span><span class="p">),</span>
            <span class="c1"># Don&#39;t follow incoming CALL_TO_FUNCTION or CALLGRAPH</span>
            <span class="c1"># edges because we don&#39;t want to pick up callsites or</span>
            <span class="c1"># calling functions</span>
            <span class="o">~</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">EdgeKind</span><span class="o">.</span><span class="n">CALL_TO_FUNCTION</span><span class="p">,</span> <span class="n">EdgeKind</span><span class="o">.</span><span class="n">CALLGRAPH</span><span class="p">]),</span>
            <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source_node</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">LLVM_LEVEL_NODES</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

    <span class="c1"># Finally, add in all of the memory locations that are reachable</span>
    <span class="c1"># from pointers in the function.</span>
    <span class="n">expanded</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">PathBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">starting_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">Node</span><span class="p">:</span> <span class="n">Node</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
        <span class="o">.</span><span class="n">continuing_while</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">Edge</span><span class="p">:</span> <span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">POINTS_TO</span><span class="p">))</span>
        <span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">cpg</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">expanded</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s start by taking a quick look at the entire CPG using the <code class="docutils literal notranslate"><span class="pre">display_cpg</span></code> function defined above.</p>
<blockquote>
<div><p><strong>Note:</strong> For even moderately-sized programs, the CPG may take an <em>extremely</em> long time to visualize, so we don’t recommend calling <code class="docutils literal notranslate"><span class="pre">display_cpg</span></code> without carefully narrowing down the set of nodes and edges you wish to see.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">NEATO</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Even this simple program has a very complex CPG!</p>
<blockquote>
<div><p><strong>Note:</strong> While the CPG for this program is too large to understand using such a visualization, you can view a larger version of this image (or others in this tutorial) by right-clicking on the image and saving it to view in a different program, or by clicking in the left margin of the notebook to zoom in on the image and enable scroll bars.</p>
</div></blockquote>
<div class="section" id="cpg-data-model">
<h3>CPG data model<a class="headerlink" href="#cpg-data-model" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">cpg</span></code> object provides an interface for querying the CPG via MATE’s embedded query language. The query language is based on the SQLAlchemy ORM framework for Python, and supports a wide-range of SQL-like query capabilities. This tutorial will demonstrate many common queries, but additional tutorials and documentation are available from the <a class="reference external" href="https://docs.sqlalchemy.org/en/13/orm/tutorial.html#querying%5D">SQLAlchemy website</a>.</p>
<p>A more detailed description of the underlying data representation and CPG schema can be found in the section <a class="reference external" href="https://mate.galois.com/stable/schemata/cpg.html">CPG Schema</a> of the MATE documentation.</p>
<p>To make writing queries more natural, MATE implements model classes that can be directly used to query specific types of nodes and relationships within the CPG. The available models, which are imported into MATE notebooks by default, are documented in the <a class="reference external" href="https://mate.galois.com/stable/api/index.html">API Reference</a> section in the <code class="docutils literal notranslate"><span class="pre">mate.cpg.models</span></code> package and its submodules.</p>
</div>
<div class="section" id="simple-queries">
<h3>Simple queries<a class="headerlink" href="#simple-queries" title="Permalink to this headline">¶</a></h3>
<p>Let’s start by writing some simple queries to understand the scale and complexity of the CPG.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Node</span></code> and <code class="docutils literal notranslate"><span class="pre">Edge</span></code> model classes of a CPG represent nodes and edges in the CPG of any type. We can write a query that selects all the corresponding entities of a model class in the CPG by calling <code class="docutils literal notranslate"><span class="pre">query</span></code> on our current <code class="docutils literal notranslate"><span class="pre">session</span></code> with the class as an argument: e.g. <code class="docutils literal notranslate"><span class="pre">session.query(cpg.Node)</span></code>. We can realize the query by invoking a method on the resulting <a class="reference external" href="https://docs.sqlalchemy.org/en/13/orm/query.html">query object</a>, such as <code class="docutils literal notranslate"><span class="pre">count</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>You can narrow the results of a query by specifying a filter. For example, we can filter on the “kind” attribute of Nodes or Edges to get a more detailed account of what’s in the CPG.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nodes by kind&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">NodeKind</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">kind</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Edges by kind&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">EdgeKind</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">kind</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To examine nodes or edges in the graph more closely, we can call <code class="docutils literal notranslate"><span class="pre">all</span></code> on a query to get the results as a python list:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Note that in this query we used the model class <code class="docutils literal notranslate"><span class="pre">Function</span></code>, which corresponds to Nodes with the kind <code class="docutils literal notranslate"><span class="pre">NodeKind.FUNCTION</span></code>. Each kind of node in the MATE CPG has an accompanying model class.</p>
<p>In addition to providing an easy way to query for a particular kind of node, model classes provide streamlined access to node attributes and relationships.</p>
<p>For example, we can query for the function whose name is “print_guesses” using the following query. We can also directly access attributes of the node via the returned python object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_guesses</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;print_guesses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="n">print_guesses</span><span class="o">.</span><span class="n">is_declaration</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p><strong>Note:</strong> You can include multiple filters in a single query by passing them as additional arguments to <code class="docutils literal notranslate"><span class="pre">filter</span></code>, calling <code class="docutils literal notranslate"><span class="pre">filter</span></code> multiple times, or combining them with logical operators. The following all return the same results:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">session.query(cpg.Node).filter(&lt;predicate</span> <span class="pre">1&gt;,</span> <span class="pre">&lt;predicate</span> <span class="pre">2&gt;).all()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">session.query(cpg.Node).filter(predicate</span> <span class="pre">1).filter(predicate</span> <span class="pre">2).all()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">session.query(cpg.Node).filter((&lt;predicate</span> <span class="pre">1&gt;)</span> <span class="pre">&amp;</span> <span class="pre">(&lt;predicate</span> <span class="pre">2&gt;)).all()</span></code></p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="call-graph-cg">
<h2>Call Graph (CG)<a class="headerlink" href="#call-graph-cg" title="Permalink to this headline">¶</a></h2>
<p>The first subgraph of the CPG we will explore is the Call Graph. The call graph connects each function to functions it might directly call or invoke using “Callgraph” edges.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">EdgeKind</span><span class="o">.</span><span class="n">CALLGRAPH</span><span class="p">])),</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p><strong>Note:</strong> The <code class="docutils literal notranslate"><span class="pre">in_</span></code> operator can be used to select nodes whose attributes are a member of a python collection or the results of another subquery.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Note:</strong> Supplying <code class="docutils literal notranslate"><span class="pre">VizProgram.DOT</span></code> (“dot”) as the <code class="docutils literal notranslate"><span class="pre">program</span></code> argument to <code class="docutils literal notranslate"><span class="pre">display_cpg</span></code> can result in nicer layouts, but is more expensive than <code class="docutils literal notranslate"><span class="pre">VizProgram.NEATO</span></code> (“neato”).</p>
</div></blockquote>
<p>There are a number of ways to traverse the callgraph using queries. We will show a few here to demonstrate different ways to interact with the query language.</p>
<p>For simple interactive exploration with a small number of nodes, you can use the <code class="docutils literal notranslate"><span class="pre">callers</span></code> and <code class="docutils literal notranslate"><span class="pre">callees</span></code> attributes of the <code class="docutils literal notranslate"><span class="pre">Function</span></code> class directly within python:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">main</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="n">main</span><span class="o">.</span><span class="n">callees</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p><strong>Note:</strong> To limit the amount of data loaded from the database at once, some attributes that represent one-to-many or many-to-many relationships are not loaded automatically, and must be manually queried using <code class="docutils literal notranslate"><span class="pre">all()</span></code>.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Note:</strong> You can see a list of attributes available for a model using the python <code class="docutils literal notranslate"><span class="pre">help</span></code> feature: e.g. <code class="docutils literal notranslate"><span class="pre">help(Function)</span></code> or by tab-completing within the Jupyter notebook.</p>
</div></blockquote>
<p>These relationship attributes can also be used within a query to follow callgraph edges within a larger SQL query. For many-to-many relationships such as <code class="docutils literal notranslate"><span class="pre">callers</span></code>, the <code class="docutils literal notranslate"><span class="pre">any</span></code> operator returns true if any related node satisfies the predicate. For many-to-one or one-to-one relationships, the <code class="docutils literal notranslate"><span class="pre">has</span></code> operator fills the same purpose.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">callers</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Relationship attributes can also be used to perform <code class="docutils literal notranslate"><span class="pre">join</span></code> queries over multiple entities in the CPG. The <code class="docutils literal notranslate"><span class="pre">join</span></code> operator works like a standard SQL join operator. The first argument is the model class to join against and the second argument is either the attribute to join on or a predicate expressing a join condition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Callee</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
<span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Callee</span><span class="p">,</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">callees</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">Callee</span><span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p><strong>Note:</strong> The various model classes for different types of nodes all represent the same set of node entities. This means that you can write <code class="docutils literal notranslate"><span class="pre">session.query(cpg.Node).filter(cpg.Function.name</span> <span class="pre">==</span> <span class="pre">&quot;main&quot;).one()</span></code>, where <code class="docutils literal notranslate"><span class="pre">cpg.Node</span></code> and <code class="docutils literal notranslate"><span class="pre">cpg.Function</span></code> refer to the same entities and return the expected result.</p>
<p>To write queries that describe relationships between multiple nodes or edges, you must create “aliases” of an appropriate model to represent each model.</p>
<p>It is helpful to think of defining an alias as defining a separate logical variable to use in your query.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Note:</strong> In practice, writing queries with explicit joins is <em>significantly</em> more performant than writing queries that filter on relationships using <code class="docutils literal notranslate"><span class="pre">has</span></code> or <code class="docutils literal notranslate"><span class="pre">any</span></code> operators.</p>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">with_entities</span></code> operator changes the set of entities involved in the query that will be return in the results. For example, we could choose to also return the <code class="docutils literal notranslate"><span class="pre">cpg.Function</span></code> entity to get a series of caller-callee pairs as results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Callee</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
<span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Callee</span><span class="p">,</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">callees</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">,</span> <span class="n">Callee</span><span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also more explicitly write this query to directly reference the edges table, though in this case one of the previous queries would be more appropriate. This query also demonstrates the use of an explicit join condition <code class="docutils literal notranslate"><span class="pre">join(cpg.Node,</span> <span class="pre">cpg.Node.uuid</span> <span class="pre">==</span> <span class="pre">cpg.Edge.target)</span></code>, which is equivalent to <code class="docutils literal notranslate"><span class="pre">join(cpg.Node,</span> <span class="pre">cpg.Edge.target_node)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">EdgeKind</span><span class="o">.</span><span class="n">CALLGRAPH</span><span class="p">,</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source_node</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="abstract-syntax-tree-ast">
<h2>Abstract Syntax Tree (AST)<a class="headerlink" href="#abstract-syntax-tree-ast" title="Permalink to this headline">¶</a></h2>
<p>For the next series of explorations of the CPG, we will focus our attention on the function <code class="docutils literal notranslate"><span class="pre">get_guess</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">get_guess</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">guess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Guess a number 1-10: &quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_num</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid entry. Try again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The bitcode of this function is:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; Function Attrs: noinline nounwind optnone uwtable</span>
<span class="k">define</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@get_guess</span><span class="p">(</span><span class="kt">i32</span><span class="p">*)</span><span class="w"> </span><span class="vg">#0</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!65</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">i0:</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w"></span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">**</span><span class="w"> </span><span class="nv">%t0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w"></span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.dbg.declare</span><span class="p">(</span><span class="k">metadata</span><span class="w"> </span><span class="kt">i32</span><span class="p">**</span><span class="w"> </span><span class="nv">%t0</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv nv-Anonymous">!68</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">metadata</span><span class="w"> </span><span class="nv">!DIExpression</span><span class="p">()),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!69</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="vg">@printf</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="p">([</span><span class="m">22</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">22</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]*</span><span class="w"> </span><span class="vg">@.str.4</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!70</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!71</span><span class="w"></span>

<span class="nl">i1:</span><span class="w">                                               </span><span class="c">; preds = %i4, %i0</span>
<span class="w">  </span><span class="nv">%t2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">**</span><span class="w"> </span><span class="nv">%t0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!72</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@read_num</span><span class="p">(</span><span class="kt">i32</span><span class="p">*</span><span class="w"> </span><span class="nv">%t2</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!75</span><span class="w"></span>
<span class="w">  </span><span class="nv">%t4</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%t3</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!76</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="nv">%t4</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i2</span><span class="p">,</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i3</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!77</span><span class="w"></span>

<span class="nl">i2:</span><span class="w">                                               </span><span class="c">; preds = %i1</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!78</span><span class="w"></span>

<span class="nl">i3:</span><span class="w">                                               </span><span class="c">; preds = %i1</span>
<span class="w">  </span><span class="nv">%t5</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">(</span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="vg">@printf</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="kt">i8</span><span class="p">*</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="p">([</span><span class="m">27</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">27</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]*</span><span class="w"> </span><span class="vg">@.str.5</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!80</span><span class="w"></span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i4</span><span class="w"></span>

<span class="nl">i4:</span><span class="w">                                               </span><span class="c">; preds = %i3</span>
<span class="w">  </span><span class="k">br</span><span class="w"> </span><span class="kt">label</span><span class="w"> </span><span class="nv">%i1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!71</span><span class="p">,</span><span class="w"> </span><span class="nv">!llvm.loop</span><span class="w"> </span><span class="nv nv-Anonymous">!82</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The Abstract Syntax Tree subgraph records information about how different program elements are related textually in the program. Because LLVM does not have structured control-flow, the resulting information is fairly minimal: there are edges between functions and their arguments, between functions and the blocks they contain, between blocks and the instructions they contain, and between functions and instructions and their types.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_guess_uuids</span> <span class="o">=</span> <span class="n">uuids_for_function</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="s2">&quot;get_guess&quot;</span><span class="p">)</span>

<span class="n">get_guess_ast</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">AST_EDGES</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">get_guess_ast</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can use AST edges to traverse between instructions and their parent blocks and functions, or to filter a query to only those instructions belonging to a function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">F</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Block</span><span class="p">)</span>

<span class="n">inst</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;get_guess&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">instructions</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">)</span>
    <span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">inst</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">parent_block</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">parent_function</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="control-flow-graph-cfg">
<h2>Control-Flow Graph (CFG)<a class="headerlink" href="#control-flow-graph-cfg" title="Permalink to this headline">¶</a></h2>
<p>The Control-Flow Graph encodes the intra-procedural control-flow between basic blocks and instructions within each function.</p>
<p>Let’s take a look at the CFG for the <code class="docutils literal notranslate"><span class="pre">get_guess</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_guess_uuids</span> <span class="o">=</span> <span class="n">uuids_for_function</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="s2">&quot;get_guess&quot;</span><span class="p">)</span>

<span class="n">get_guess_cfg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">LOCAL_CONTROL_FLOW_FORWARD</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">get_guess_cfg</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">VizStrategy</span><span class="o">.</span><span class="n">IR_SUBGRAPHS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="control-dependence-graph-cdg">
<h2>Control-Dependence Graph (CDG)<a class="headerlink" href="#control-dependence-graph-cdg" title="Permalink to this headline">¶</a></h2>
<p>The Control-Dependency Graph has edges between blocks and instructions that are control-dependent on each other.
An instruction is control-dependent on another if whether it is executed depends on the control-flow leaving the controlling instruction. For example, the body of a loop is control-dependent on the branch instruction of the loop guard. In this snippet of code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">some_condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">stmt1</span><span class="p">;</span><span class="w">   </span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">stmt2</span><span class="p">;</span><span class="w">   </span>
<span class="p">}</span><span class="w"></span>
<span class="n">stmt3</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">stmt1</span></code> and <code class="docutils literal notranslate"><span class="pre">stmt2</span></code> are control dependent on <code class="docutils literal notranslate"><span class="pre">some_condition</span></code>, but <code class="docutils literal notranslate"><span class="pre">stmt3</span></code> is not.</p>
<p>Compare the control-dependency graph for <code class="docutils literal notranslate"><span class="pre">get_guess</span></code> to the control-flow graph for <code class="docutils literal notranslate"><span class="pre">get_guess</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_guess_uuids</span> <span class="o">=</span> <span class="n">uuids_for_function</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="s2">&quot;get_guess&quot;</span><span class="p">)</span>

<span class="n">get_guess_cdg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">CONTROL_DEP_FORWARD</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">get_guess_cdg</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Control dependence can be useful for understanding the conditions under which code executes. For example, we can use a path query in the CDG to find what nodes control printing the “You win!” message in <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">you_win</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="o">.</span><span class="n">callees</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;printf&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;23&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">cdg_query</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">PathBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">stopping_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">Node</span><span class="p">:</span> <span class="n">Node</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">you_win</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="o">.</span><span class="n">continuing_while</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">Edge</span><span class="p">:</span> <span class="n">Edge</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">EdgeKind</span><span class="o">.</span><span class="n">TERMINATOR_INSTRUCTION_TO_CONTROL_DEPENDENT_INSTRUCTION</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">cpg</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">controllers</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cdg_query</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">,</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">cdg_query</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">controller</span> <span class="ow">in</span> <span class="n">controllers</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;pretty_string&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>This query uses a “path” query to find all nodes reachable in the CDG from the start node. The <code class="docutils literal notranslate"><span class="pre">PathBuilder</span></code> constructor specifies a path traversal to run within the CPG using a “fluent” interface where method calls are chained to refine the desired path.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">stopping_at</span></code> operator takes a function that takes a Node class object as an argument and returns a predicate describing which nodes in the graph paths must end at. There is an analogous <code class="docutils literal notranslate"><span class="pre">starting_at</span></code> operator that specifies where the paths should start. If either of these operators are not called, then the path will start (or stop) at any node. The <code class="docutils literal notranslate"><span class="pre">continuing_while</span></code> operator takes a function whose arguments are a class representing the current state of the traversal and an Edge class object, and must return a predicate indicating whether that edge should be traversed from the current state.</p>
<p>For example, you could force the query to stay in a single function using the following filter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">continuing_while</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">Edge</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Edge</span><span class="o">.</span><span class="n">target_node</span><span class="o">.</span><span class="n">has</span><span class="p">(</span>
            <span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">has</span><span class="p">(</span>
                <span class="n">cpg</span><span class="o">.</span><span class="n">Block</span><span class="o">.</span><span class="n">parent_function</span><span class="o">.</span><span class="n">has</span><span class="p">(</span>
                    <span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span> 
<span class="p">)</span>
</pre></div>
</div>
<p>In this case, this filter is not necessary.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">reverse</span></code> operator changes the direction along which edges are followed during the search. Typically, if you specify <code class="docutils literal notranslate"><span class="pre">stopping_at</span></code> but not <code class="docutils literal notranslate"><span class="pre">starting_at</span></code>, you should specify a reverse traversal. If you provide both <code class="docutils literal notranslate"><span class="pre">starting_at</span></code> and <code class="docutils literal notranslate"><span class="pre">stopping_at</span></code>, you should chose the direction of search based on which is likely to to explore less of the graph.</p>
<blockquote>
<div><p><strong>Note:</strong> the source and target nodes of the Edge passed to the continuing while predicate are not swapped if you specify <code class="docutils literal notranslate"><span class="pre">reverse</span></code>.</p>
</div></blockquote>
<p>The final call to <code class="docutils literal notranslate"><span class="pre">build()</span></code> runs the traversal and returns a new model class representing the path with attributes such as the <code class="docutils literal notranslate"><span class="pre">source</span></code> and <code class="docutils literal notranslate"><span class="pre">target</span></code> uuids of nodes of the path. A common pattern is to join these attributes with the Node table, as shown in this example.</p>
<p>We write another visualization function to help understand the results of this query:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visualize_ctxt</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">pointer</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot; --&gt; &quot;</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pointer</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ndir</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
            <span class="n">nfile</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
            <span class="n">nline</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span>
            <span class="n">nstr</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">location_string</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin</span><span class="si">}{</span><span class="n">nstr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin</span><span class="si">}{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nstr</span><span class="p">),</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nline</span><span class="o">-</span><span class="n">window_size</span><span class="p">,</span><span class="n">nline</span><span class="o">+</span><span class="n">window_size</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">==</span> <span class="n">ndir</span><span class="p">,</span>
                        <span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">==</span> <span class="n">nfile</span><span class="p">,</span>
                        <span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_integer</span><span class="p">()</span> <span class="o">==</span> <span class="n">l</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;source_code&#39;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pointer</span> <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">nline</span> <span class="k">else</span> <span class="n">margin</span><span class="si">}{</span><span class="n">l</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">code</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">parent_function</span><span class="o">.</span><span class="n">name</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin</span><span class="si">}{</span><span class="n">fun</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin</span><span class="si">}{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pointer</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">inst</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;pretty_string&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
            
            

<span class="n">visualize_ctxt</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">controllers</span><span class="p">,</span> <span class="s2">&quot;controlling instruction&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As we might hope, you can only win the game if you guess the number correctly and you haven’t run out of guesses yet.</p>
</div>
<div class="section" id="data-flow-graph-dfg">
<h2>Data-Flow Graph (DFG)<a class="headerlink" href="#data-flow-graph-dfg" title="Permalink to this headline">¶</a></h2>
<p>The Data-Flow Graph encodes data dependencies between instructions and memory locations in the program and abstracts away the control structure of the program.</p>
<p>Compare the data-flow graph for the get_guess function to its control-flow graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_guess_uuids</span> <span class="o">=</span> <span class="n">uuids_for_function</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="s2">&quot;get_guess&quot;</span><span class="p">)</span>

<span class="n">get_guess_dfg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">DATA_FLOW_FORWARD</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">get_guess_dfg</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This graph has been restricted to only intra-procedural data flows becuase we filter on Nodes for the <code class="docutils literal notranslate"><span class="pre">get_guess</span></code> function, but the dataflow graph can also be traversed intra-procedurally in two ways:</p>
<ol class="arabic simple">
<li><p>through parameter binding and call return nodes, described in the section “Understanding function call subgraphs” below.</p></li>
<li><p>through loads and stores to memory accessible in multiple functions,</p></li>
</ol>
<p>This dataflow graph also includes a node for a dataflow signature for the <code class="docutils literal notranslate"><span class="pre">printf</span></code> function. You can learn more about dataflow signatures in the “Mate Signatures” section of the MATE documentation.</p>
</div>
<div class="section" id="inter-procedural-data-flow">
<h2>Inter-procedural data-flow<a class="headerlink" href="#inter-procedural-data-flow" title="Permalink to this headline">¶</a></h2>
<p>Naively tracing data-flow inter-procedurally by following dataflow edges in the CPG can result in false-positives because not all sequences of dataflow edges in the graph are realizable during program execution. For example, consider this simple program:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">propagate</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propagate</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">propagate</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The data-flow graph contains paths from both <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> to the argument <code class="docutils literal notranslate"><span class="pre">x</span></code> of <code class="docutils literal notranslate"><span class="pre">propagate</span></code> and paths from both the return value of <code class="docutils literal notranslate"><span class="pre">propagate</span></code> to <code class="docutils literal notranslate"><span class="pre">c</span></code> and <code class="docutils literal notranslate"><span class="pre">d</span></code>. As a result, simply following these dataflow edges in the graph will report that <code class="docutils literal notranslate"><span class="pre">a</span></code> flows to both <code class="docutils literal notranslate"><span class="pre">c</span></code> and <code class="docutils literal notranslate"><span class="pre">d</span></code> and that <code class="docutils literal notranslate"><span class="pre">b</span></code> flows to both <code class="docutils literal notranslate"><span class="pre">c</span></code> and <code class="docutils literal notranslate"><span class="pre">d</span></code>. In this case, the cause of the imprecision is the failure of the analysis to track C’s stack-based call discipline, which ensures that each call to <code class="docutils literal notranslate"><span class="pre">propagate</span></code> returns to its original callsite.</p>
<p>Similar imprecision can occur when tracking dataflows through memory locations because aliasing in the program can also depend on the history of the program’s execution.</p>
<p>To achieve significantly improved precision for queries about inter-procedural dataflow, MATE has an interface for expressing graph traversals as “context-free-language reachability” (CFL-reachability) queries. A CFL-reachability query matches paths in the graph whose edge labels are members of a specified context-free language. An example such language is the language of well-matched function calls and returns, which can filter out infeasible paths like the flows from <code class="docutils literal notranslate"><span class="pre">a</span></code> to <code class="docutils literal notranslate"><span class="pre">d</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> to <code class="docutils literal notranslate"><span class="pre">c</span></code> in the example above.</p>
<p>CFL-reachability queries use the same <code class="docutils literal notranslate"><span class="pre">PathBuilder</span></code> interface as the path queries described above, but must specify a base <code class="docutils literal notranslate"><span class="pre">Path</span></code> class in the call to the <code class="docutils literal notranslate"><span class="pre">PathBuilder()</span></code> constructor. A number of built-in CFL traversals are provided in the <a class="reference external" href="https://mate.galois.com/master/api/MATEQuery/mate_query.cfl.html"><code class="docutils literal notranslate"><span class="pre">cfl</span></code> module</a>. The query below uses the <code class="docutils literal notranslate"><span class="pre">cfl.CSThingDataflowPath</span></code> class for precise inter-procedural dataflow.</p>
<p>It starts at all <code class="docutils literal notranslate"><span class="pre">InputSignature</span></code> nodes that represent potential user input from the library function <code class="docutils literal notranslate"><span class="pre">scanf</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scanf_signatures</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">InputSignature</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">InputSignature</span><span class="o">.</span><span class="n">signature_for_function</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__isoc99_scanf&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">scanf_dataflow</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">PathBuilder</span><span class="p">(</span><span class="n">cfl</span><span class="o">.</span><span class="n">CSThinDataflowPath</span><span class="p">)</span>
    <span class="o">.</span><span class="n">starting_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">Node</span><span class="p">:</span> <span class="n">Node</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">cs</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">scanf_signatures</span><span class="p">]))</span>
    <span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">keep_edge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">scanf_dataflow_edges</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">scanf_dataflow</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">,</span> <span class="n">scanf_dataflow</span><span class="o">.</span><span class="n">edge</span> <span class="o">==</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">scanf_dataflow_edges</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="information-flow-graph-ifg">
<h2>Information-Flow Graph (IFG)<a class="headerlink" href="#information-flow-graph-ifg" title="Permalink to this headline">¶</a></h2>
<p>The Information-Flow Graph combines the Control-Dependence and Data-Flow Graphs. Tracing relationships in the information-flow graph will find all the data and instructions that influence the computation of a result. If you are familiar with research in information-flow security, you can think of the IFG as combining tracking of “explicit flows” from the DFG with tracking of “implicit flows” from the CDG.</p>
<p>Let’s compare the IFG with DFG for <code class="docutils literal notranslate"><span class="pre">get_guess</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_guess_uuids</span> <span class="o">=</span> <span class="n">uuids_for_function</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="s2">&quot;get_guess&quot;</span><span class="p">)</span>

<span class="n">get_guess_ifg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">INFO_FLOW_FORWARD</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">),</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">get_guess_uuids</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">get_guess_ifg</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also re-examine what influences the “You win!” message through a wider lens:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">you_win</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="o">.</span><span class="n">callees</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;printf&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;23&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">ifg_query</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">PathBuilder</span><span class="p">()</span>
    <span class="o">.</span><span class="n">stopping_at</span><span class="p">(</span><span class="k">lambda</span> <span class="n">Node</span><span class="p">:</span> <span class="n">Node</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">you_win</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="o">.</span><span class="n">continuing_while</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">Edge</span><span class="p">:</span> <span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">INFO_FLOW_FORWARD</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">cpg</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">influencers</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ifg_query</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">,</span> <span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">ifg_query</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Instruction</span><span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">visualize_ctxt</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">influencers</span><span class="p">,</span> <span class="s2">&quot;influencing instruction&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our query now also returns interesting lines such as where the secret is initialized:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                            <span class="n">guessing</span><span class="o">-</span><span class="n">game</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="n">main</span>
                            <span class="o">==========================</span>
                            <span class="mi">14</span><span class="p">:</span>	
<span class="n">influencing</span> <span class="n">instruction</span> <span class="o">--&gt;</span> <span class="mi">15</span><span class="p">:</span>	<span class="n">hidden</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                            <span class="mi">16</span><span class="p">:</span>	
</pre></div>
</div>
<blockquote>
<div><p><strong>Note:</strong> This list includes many duplicate source lines because compiling a C statement often results in many LLVM bitcode instructions.</p>
</div></blockquote>
</div>
<div class="section" id="points-to-graph-ptg">
<h2>Points-To Graph (PTG)<a class="headerlink" href="#points-to-graph-ptg" title="Permalink to this headline">¶</a></h2>
<p>The Points-To Graph encodes information about the structure of memory during execution. It is generated by a whole-program static analysis that takes place before CPG construction.</p>
<p>Each node in the points-to graph represents an abstraction of a set of concrete memory locations that could exist at runtime. The point-to analysis used by MATE type and field sensitive, so a memory location might be represented by more than one node in order to allow more precise reasoning about accesses to subobjects. For example, consider the following snippet of C:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
</pre></div>
</div>
<p>The pointer <code class="docutils literal notranslate"><span class="pre">b</span></code> might point to memory location nodes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">heap_alloc&#64;main[i32</span> <span class="pre">%t0][1]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">typed_heap_alloc&#64;main[i32</span> <span class="pre">%t0][1]</span></code></p></li>
</ul>
<p>Tracking points-to information at this fine-grained level makes it possible to accurately track dataflows through structures and other arrays.</p>
<p>Sometimes it is necessary to find less-precise information about a pointer, for example when finding other uses of a memory object at a different granualarity. To facilite this, the CPG between memory locations that must alias (such as <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">&amp;a[0]</span></code>), that may alias (such as <code class="docutils literal notranslate"><span class="pre">&amp;a[0]</span></code> and <code class="docutils literal notranslate"><span class="pre">&amp;a[x]</span></code> where <code class="docutils literal notranslate"><span class="pre">x</span></code> is unknown, and that are subregions of each other (such as <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">&amp;a[1]</span></code>).</p>
<p>Let’s take a look at the points-to graph for the guessing game program:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">node_query</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">MemoryLocation</span><span class="p">),</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">NEATO</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="inter-procedural-control-flow-graph-icfg">
<h2>Inter-procedural Control-Flow Graph (ICFG)<a class="headerlink" href="#inter-procedural-control-flow-graph-icfg" title="Permalink to this headline">¶</a></h2>
<p>The Inter-procedural Control-Flow Graph is a subgraph of the CPG that connects each function’s CFG into a single graph. For small programs, it is possible to visualize the entir program’s ICFG at once:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">icfg</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">CONTROL_FLOW_FORWARD</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">LLVM_LEVEL_NODES</span><span class="p">))</span>
<span class="p">)</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span> <span class="n">edge_query</span><span class="o">=</span><span class="n">icfg</span><span class="p">,</span> <span class="n">node_query</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">VizStrategy</span><span class="o">.</span><span class="n">IR_SUBGRAPHS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="understanding-function-call-subgraphs">
<h3>Understanding function call subgraphs<a class="headerlink" href="#understanding-function-call-subgraphs" title="Permalink to this headline">¶</a></h3>
<p>To retain precision when reasoning about control- and data-flows through a function with multiple callsites, the CPG has special “Parameter Binding” and “Call Return” nodes that are inserted between each callsite and the function it invokes. To better understand these nodes and how they are used, let’s zoom in on the call to <code class="docutils literal notranslate"><span class="pre">read_num</span></code> inside the <code class="docutils literal notranslate"><span class="pre">get_guess</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the Function node</span>
<span class="n">readnum</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;read_num&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="n">relevant</span> <span class="o">=</span> <span class="p">[</span><span class="n">readnum</span><span class="p">]</span>

<span class="c1"># Find the CallSite node</span>
<span class="n">readnum_callsite</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">CallSite</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="s2">&quot;read_num&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="n">relevant</span> <span class="o">+=</span> <span class="p">[</span><span class="n">readnum_callsite</span><span class="p">]</span>

<span class="c1"># Add the arguments to the Call</span>
<span class="n">operands</span> <span class="o">=</span> <span class="n">readnum_callsite</span><span class="o">.</span><span class="n">uses</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">relevant</span> <span class="o">+=</span> <span class="n">operands</span>

<span class="c1"># Add the parameter binding nodes for the call</span>
<span class="n">binding_nodes</span> <span class="o">=</span> <span class="n">readnum_callsite</span><span class="o">.</span><span class="n">binds</span>
<span class="n">relevant</span> <span class="o">+=</span> <span class="n">binding_nodes</span>

<span class="c1"># Add the function&#39;s argument nodes</span>
<span class="n">arguments</span> <span class="o">=</span> <span class="n">readnum</span><span class="o">.</span><span class="n">arguments</span>
<span class="n">relevant</span> <span class="o">+=</span> <span class="n">arguments</span>
<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
    <span class="c1"># And the instructions that use the argument to hint at the dataflow within read_num</span>
    <span class="n">relevant</span> <span class="o">+=</span> <span class="n">arg</span><span class="o">.</span><span class="n">used_by</span>

<span class="c1"># Add the call return node for the call</span>
<span class="n">return_node</span> <span class="o">=</span> <span class="n">readnum_callsite</span><span class="o">.</span><span class="n">returns_from</span>
<span class="n">relevant</span> <span class="o">+=</span> <span class="p">[</span><span class="n">return_node</span><span class="p">]</span>
<span class="c1"># Add the return instruction</span>
<span class="n">relevant</span> <span class="o">+=</span> <span class="p">[</span><span class="n">return_node</span><span class="o">.</span><span class="n">returns_from</span><span class="p">]</span>
<span class="c1"># Add the return value</span>
<span class="n">relevant</span> <span class="o">+=</span> <span class="p">[</span><span class="n">return_node</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

<span class="n">display_cpg</span><span class="p">(</span><span class="n">cpg</span><span class="p">,</span>
            <span class="n">node_query</span><span class="o">=</span><span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">relevant</span><span class="p">]))</span>
            <span class="p">),</span>
            <span class="n">edge_query</span><span class="o">=</span><span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">cpg</span><span class="o">.</span><span class="n">Edge</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">notin_</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">EdgeKind</span><span class="o">.</span><span class="n">FUNCTION_TO_ENTRY_BLOCK</span><span class="p">,</span><span class="n">EdgeKind</span><span class="o">.</span><span class="n">BLOCK_TO_TERMINATOR_INSTRUCTION</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">program</span><span class="o">=</span><span class="n">VizProgram</span><span class="o">.</span><span class="n">DOT</span>
           <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For each argument at a callsite, there is a “ParamBinding” node that represents the assignment of the call’s argument to the corresponding function’s argument. This node is connected to the CallSite by a “CallToParamBinding” edge and to the function argument it binds by a “ParamBindingToArg” edge.  It is also connected to the call’s “CallReturn” node.</p>
<p>The CallReturn node has edges from each of the callee’s return instructions as well as an edge from the instructions that define the function’s return value.</p>
<p>The edges between CallSites and all of their corresponding ParamBinding and CallReturn nodes add structure to the ICFG that can be useful when trying to reason about flows through functions with many callsites.</p>
</div>
</div>
<div class="section" id="query-language-tips-and-tricks">
<h2>Query language tips and tricks<a class="headerlink" href="#query-language-tips-and-tricks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="corrupted-cpg-session">
<h3>Corrupted cpg session<a class="headerlink" href="#corrupted-cpg-session" title="Permalink to this headline">¶</a></h3>
<p>If running a query reports a problem related to the state of the database connection, try rolling back the session by issuing the command</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cpg</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<div class="section" id="exercise-1">
<h3>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this headline">¶</a></h3>
<p>Find the locations of all of the call sites in the program where the <code class="docutils literal notranslate"><span class="pre">printf</span></code> function is invoked, along with which functions contain them.</p>
<blockquote>
<div><p><strong>Hint:</strong> You can see documentation of available attributes for a model class by invoking <code class="docutils literal notranslate"><span class="pre">help()</span></code> on the class (e.g., <code class="docutils literal notranslate"><span class="pre">help(cpg.Instruction)</span></code>).</p>
</div></blockquote>
<blockquote>
<div><p><strong>Hint:</strong> The <code class="docutils literal notranslate"><span class="pre">cpg.CallSite</span></code> model has a special attribute <code class="docutils literal notranslate"><span class="pre">.calls</span></code> that can be used to filter for CallSites that call the function whose name is given as an argument to <code class="docutils literal notranslate"><span class="pre">.calls</span></code>.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Hint:</strong> Instruction objects (including nodes returned by <code class="docutils literal notranslate"><span class="pre">cpg.CallSite</span></code> queries) have a <code class="docutils literal notranslate"><span class="pre">parent_block</span></code> attribute and blocks have a <code class="docutils literal notranslate"><span class="pre">parent_function</span></code> attribute.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Hint:</strong> Instruction objects have a <code class="docutils literal notranslate"><span class="pre">.location</span></code> attribute.</p>
</div></blockquote>
</div>
<div class="section" id="exercise-2">
<h3>Exercise 2<a class="headerlink" href="#exercise-2" title="Permalink to this headline">¶</a></h3>
<p>Find pairs of locations of callsites in the program that take input from the user and provide output to the user where the inputs and outputs are connected via dataflow.</p>
<blockquote>
<div><p><strong>Hint:</strong> Use a <code class="docutils literal notranslate"><span class="pre">cfl.CSThinDataflowPath</span></code> path in your query.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Hint:</strong> The predicates <code class="docutils literal notranslate"><span class="pre">Node.Kind</span> <span class="pre">==</span> <span class="pre">NodeKind.INPUT_SIGNATURE</span></code> and <code class="docutils literal notranslate"><span class="pre">Node.Kind</span> <span class="pre">==</span> <span class="pre">NodeKind.OUTPUT_SIGNATURE</span></code> match input and output signature nodes, respectively.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Hint:</strong> Passing the argument <code class="docutils literal notranslate"><span class="pre">keep_start=True</span></code> to <code class="docutils literal notranslate"><span class="pre">db.PathBuilder</span></code>’s <code class="docutils literal notranslate"><span class="pre">.build()</span></code> method makes the resulting query object’s <code class="docutils literal notranslate"><span class="pre">.source</span></code> and <code class="docutils literal notranslate"><span class="pre">.target</span></code> attributes include the uuids of the path’s start and end, respectively.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Hint:</strong> Part of your solution should use a query with provided aliases to output pairs of Input and Output Signatures by joining on these classes and including the clause <code class="docutils literal notranslate"><span class="pre">.with_entities(InputSig,</span> <span class="pre">OutputSig)</span></code>.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Hint:</strong> Signature objects have an attribute <code class="docutils literal notranslate"><span class="pre">signature_for</span></code> connecting them to their corresponding callsites.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">InputSig</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">InputSignature</span><span class="p">)</span>
<span class="n">OutputSig</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">cpg</span><span class="o">.</span><span class="n">OutputSignature</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise-3">
<h3>Exercise 3<a class="headerlink" href="#exercise-3" title="Permalink to this headline">¶</a></h3>
<p>Find the possible call stacks at the input and output calls you found in exercise 2.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="tutorial-flowfinder.html" class="btn btn-neutral float-right" title="Flowfinder Tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="ui-walkthrough.html" class="btn btn-neutral float-left" title="UI Walkthrough" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019-2022, The MATE Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>