

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Under-constrained Manticore &mdash; MATE 0.1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_paramlinks.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="UsageFinder" href="usagefinder.html" />
    <link rel="prev" title="Traces" href="trace.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> MATE
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial-flowfinder.html">Flowfinder Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command-Line Tools Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli-overview.html">CLI Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpg.html">The Code Property Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging-builds.html">Debugging Program Build Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="dwarfcore.html">Dwarfcore</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">Environment variables in the MATE container</a></li>
<li class="toctree-l1"><a class="reference internal" href="mantiserve.html">Mantiserve</a></li>
<li class="toctree-l1"><a class="reference internal" href="pois.html">Points of Interest</a></li>
<li class="toctree-l1"><a class="reference internal" href="schemata/cpg.html">CPG Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="signatures.html">MATE Signatures</a></li>
<li class="toctree-l1"><a class="reference internal" href="trace.html">Traces</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Under-constrained Manticore</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#starting-an-under-constrained-manticore-task">Starting an under-constrained Manticore task</a></li>
<li class="toctree-l2"><a class="reference internal" href="#specifying-additional-symbolic-constraints">Specifying additional symbolic constraints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#constraints-on-function-parameters">Constraints on function parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#meta-variables">Meta-variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#points-within-constraints"><code class="docutils literal notranslate"><span class="pre">$POINTS_WITHIN</span></code> constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generic-class-constraints">Generic class constraints</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#state-forking">State forking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="usagefinder.html">UsageFinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-flowfinder.html">Using Flowfinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-notebooks.html">MATE Python Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-rest-api.html">Using the REST API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">MATE API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html#indices-and-tables">Indices and tables</a></li>
<li class="toctree-l1"><a class="reference external" href="api.html#http://">MATE REST API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hacking.html">Hacking on MATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="legal.html">Legal</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Writing and running MATE’s tests</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MATE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Under-constrained Manticore</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/under-constrained-manticore.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="under-constrained-manticore">
<h1>Under-constrained Manticore<a class="headerlink" href="#under-constrained-manticore" title="Permalink to this headline">¶</a></h1>
<p>MATE provides a web UI for exploring programs with the <a class="reference external" href="https://github.com/trailofbits/manticore">Manticore</a> symbolic execution engine in an
<em>under-constrained</em> mode. Unlike traditional symbolic execution which begins at
the program entry point and executes until the program exits, under-constrained
symbolic execution starts at an arbitrary function. This specificity means that
under-constrained symbolic execution can analyze parts of programs that would be
too large or complex for traditional symbolic execution.</p>
<p>Symbolic execution enables bit-precise local reasoning about memory and
arithmetic, which complements MATE’s higher-level inter-procedural data- and
control-flow analyses.</p>
<p>Under-constrained execution is implemented as a Manticore Plugin, which means it
can be enabled/disabled easily, and should be able to coexist with other
<a class="reference internal" href="mantiserve.html#detectors"><span class="std std-ref">detectors</span></a> such as the UAF or variable-bounds detectors.</p>
<p>In broad terms, under-constrained Manticore works as follows:</p>
<ul>
<li><p><strong>Program initialization</strong>:
the program is run normally from its entry-point, until the <code class="docutils literal notranslate"><span class="pre">main</span></code> function
is reached. This allows shared libraries to be properly initialized, as well as
any globals in the program. When <code class="docutils literal notranslate"><span class="pre">main</span></code> is reached, Manticore jumps directly to
the beginning of the target function and continues from there</p></li>
<li><p><strong>Target function setup</strong>:
when jumping directly to the target function, Manticore needs to provide proper
function arguments as if it was normally called from within the program. To do so,
it uses the CPG to infer the expected arguments and their types, and creates
a symbolic expression for every argument. So the target function is called with fully
symbolic inputs.</p></li>
<li><p><strong>Symbolic pointers</strong>:
when a function takes a pointer as argument, e.g <code class="docutils literal notranslate"><span class="pre">foo(int</span> <span class="pre">*ptr)</span></code>, and that pointer is
dereferenced in the function’s body, Manticore has to rely on a special memory model.
In a normal Manticore run, <code class="docutils literal notranslate"><span class="pre">ptr</span></code> would have been initialized previously by the program,
but in under-constrained mode it is purely symbolic, and doesn’t point to any real
allocated data. So Manticore will artificially allocate a symbolic object pointed by
<code class="docutils literal notranslate"><span class="pre">ptr</span></code> (and thus containing only symbolic data as well), and read inside that object rather
than in the regular memory when <code class="docutils literal notranslate"><span class="pre">ptr</span></code> is dereferenced.
Note that underlying usage of a special memory layout happens seamlessly.</p></li>
<li><p><strong>Out-of-bounds memory access detection</strong>:
when the program reads from a symbolic offset in an under-constrained object, for instance:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>under-constrained Manticore is able
to detect if the access can be out-of-bounds by using the solver to determine whether
the symbolic offset can exceed the bounds of the object. If yes, then it will record
a test case indicating a potential OOB error.</p>
</li>
</ul>
<div class="section" id="starting-an-under-constrained-manticore-task">
<h2>Starting an under-constrained Manticore task<a class="headerlink" href="#starting-an-under-constrained-manticore-task" title="Permalink to this headline">¶</a></h2>
<p>Under-constrained Manticore tasks are started just like regular Manticore exploration tasks.
The request format is available in the <a class="reference external" href="api.html#operation/_execute_manticore_exploration_task_api_v1_manticore_explore__build_id__post">MATE REST API documentation</a>
by selecting <code class="docutils literal notranslate"><span class="pre">ExploreFunctionOptions</span></code> in the request.</p>
<p>The exploration options that are passed with the API call are similar to the regular exploration
options with some additional settings:</p>
<ul class="simple">
<li><p><strong>target_function</strong>: the name of the target function to execute. In case of a C++ binary
the name must be mangled.</p></li>
<li><p><strong>input_constraints</strong>: additional symbolic state constraints. Those can be used to
constrain Manticore further to eliminate possible errors that are false positive or
to optimize the execution time by trimming some exploration paths. See the
<a class="reference internal" href="#constraints-dsl"><span class="std std-ref">Specifying additional symbolic constraints</span></a> section for more details.</p></li>
<li><p><strong>primitive_ptr_policy</strong>: the policy for choosing the length of unbounded symbolic arrays
that contain primitive types. The default policy lets Manticore choose reasonable lengths
for arrays, but the user can specify explicit lengths to use by switching to the
<code class="docutils literal notranslate"><span class="pre">custom</span></code> policy.</p></li>
<li><p><strong>complex_ptr_policy</strong>: the policy for choosing the length of unbounded symbolic arrays
that contain complex types such as structures or objects. The default policy lets
Manticore choose reasonable lengths for arrays, but the user can specify explicit lengths
to use by switching to the <code class="docutils literal notranslate"><span class="pre">custom</span></code> policy.</p></li>
</ul>
</div>
<div class="section" id="specifying-additional-symbolic-constraints">
<span id="constraints-dsl"></span><h2>Specifying additional symbolic constraints<a class="headerlink" href="#specifying-additional-symbolic-constraints" title="Permalink to this headline">¶</a></h2>
<p>Sending additional symbolic constraints is central in the under-constrained Manticore
workflow. When first starting a task it is very likely that Manticore will report many errors
that are false positives. Incrementally adding constraints and re-launching the task allows
to eliminate the false positives and keep only the interesting results.</p>
<p>Two examples of using constraints are:</p>
<ul>
<li><p><strong>relationship between function arguments</strong>:
consider the following <code class="docutils literal notranslate"><span class="pre">strcpy</span></code>-like function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">my_strcpy</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">dst</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">src</span><span class="o">++</span><span class="p">))){};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">src</span></code> is longer than <code class="docutils literal notranslate"><span class="pre">dst</span></code>, Manticore will return a potential out-of-bounds memory
write error. However, in some cases, we might be <strong>sure</strong> (or want to assume) that
<code class="docutils literal notranslate"><span class="pre">src</span></code> is smaller than <code class="docutils literal notranslate"><span class="pre">dst</span></code>. Using a symbolic constraint will allow use to enforce
the size relationship between <code class="docutils literal notranslate"><span class="pre">src</span></code> and <code class="docutils literal notranslate"><span class="pre">dst</span></code> in Manticore and remove the out-of-bounds
error.</p>
</li>
<li><p><strong>data structure invariants</strong>:
imagine a function that takes the following struct as argument:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">string</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="c1">// Length of &#39;str&#39;</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>under-constrained Manticore doesn’t know that <code class="docutils literal notranslate"><span class="pre">len</span></code> if referring to the size
of <code class="docutils literal notranslate"><span class="pre">str</span></code>. While in some cases avoiding to correlate <code class="docutils literal notranslate"><span class="pre">len</span></code> and <code class="docutils literal notranslate"><span class="pre">str</span></code>
could help find bugs withing the <code class="docutils literal notranslate"><span class="pre">string</span></code> implementation, we will often want
to inform Manticore of the relationship between those two variables (one is
the size of the other) so that the <code class="docutils literal notranslate"><span class="pre">string</span></code> struct behaves correctly and
doesn’t cause many false positive errors that will hide other interesting
findings. This becomes even more true when using classes of the C++ standard
library like <code class="docutils literal notranslate"><span class="pre">std::vector</span></code>, <code class="docutils literal notranslate"><span class="pre">std::string</span></code>, etc, of whom Manticore <strong>must</strong>
assume that their implementations and internals are bug-free.</p>
</li>
</ul>
<p>Symbolic constraints can be written using the Domain-Specific-Language (DSL) described below.</p>
<div class="section" id="constraints-on-function-parameters">
<h3>Constraints on function parameters<a class="headerlink" href="#constraints-on-function-parameters" title="Permalink to this headline">¶</a></h3>
<p>Basic constraints on function parameters can be expressed using regular
arithmetic and logic operations and by following the variable naming found
in the source code. For example if we target the <code class="docutils literal notranslate"><span class="pre">foo</span></code> function:</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">A</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>We could add the following constraint on the <code class="docutils literal notranslate"><span class="pre">x</span></code> argument:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="mi">10</span>
</pre></div>
</div>
</div></blockquote>
<p>Most of the operations can be expressed using the corresponding standard C operator
(<code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">-</span></code>, <code class="docutils literal notranslate"><span class="pre">*</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>, <code class="docutils literal notranslate"><span class="pre">^</span></code>, <code class="docutils literal notranslate"><span class="pre">%</span></code>, etc). However, many operators exist in both <em>signed</em>
and <em>unsigned</em> versions. In order to distinguish between them, some operators are written using a
function-like syntax (<code class="docutils literal notranslate"><span class="pre">&lt;operator&gt;(arg1,</span> <span class="pre">arg2,</span> <span class="pre">...)</span></code>):</p>
<ul class="simple">
<li><p>Unsigned comparisons: <code class="docutils literal notranslate"><span class="pre">ULE()</span></code>, <code class="docutils literal notranslate"><span class="pre">ULT()</span></code>, <code class="docutils literal notranslate"><span class="pre">UGE()</span></code>, <code class="docutils literal notranslate"><span class="pre">UGT()</span></code>  (<code class="docutils literal notranslate"><span class="pre">&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, etc, default to signed comparisons)</p></li>
<li><p>Signed division: <code class="docutils literal notranslate"><span class="pre">SDIV()</span></code> (<code class="docutils literal notranslate"><span class="pre">/</span></code> defaults to unsigned division)</p></li>
<li><p>Arithmetic shift left: <code class="docutils literal notranslate"><span class="pre">SAR()</span></code></p></li>
<li><p>Concatenation: <code class="docutils literal notranslate"><span class="pre">CONCAT(&lt;higher&gt;,</span> <span class="pre">&lt;lower&gt;)</span></code></p></li>
<li><p>Bitfield extract: <code class="docutils literal notranslate"><span class="pre">EXTRACT(&lt;arg&gt;,</span> <span class="pre">&lt;offset&gt;,</span> <span class="pre">&lt;size&gt;)</span></code></p></li>
</ul>
</div>
<div class="section" id="meta-variables">
<span id="id1"></span><h3>Meta-variables<a class="headerlink" href="#meta-variables" title="Permalink to this headline">¶</a></h3>
<p>The symbolic constraint DSL offers a few special operators that refer to “properties” of
variables rather than to the variable themselves. Since every property of every object is
represented by a dedicated unique symbolic variable, we call those <strong>meta-variables</strong>.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">$LEN(&lt;var&gt;)</span></code>: can be used to refer to the length of an array pointed by a raw pointer.
When under-constrained Manticore receives an unbounded pointer (e.g <code class="docutils literal notranslate"><span class="pre">int*</span></code>) it has
to guess if the pointer points to a single integer in memory, or if it points to an
array of integers. In addition to hard-coded heuristics, users can give hints or constrain
array sizes using <code class="docutils literal notranslate"><span class="pre">$LEN()</span></code>. For instance, <code class="docutils literal notranslate"><span class="pre">$LEN(buf)</span> <span class="pre">&lt;</span> <span class="pre">20</span></code> tells Manticore that the number
of elements pointed by <code class="docutils literal notranslate"><span class="pre">buf</span></code> is less than 20.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code class="docutils literal notranslate"><span class="pre">$LEN()</span></code> refers to the <em>number of contiguous elements</em> of an array in memory, and <strong>not</strong>
the total length in bytes of the array</p>
</div>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">$CAPACITY(&lt;var&gt;)</span></code>: this refers to the total capacity of a container class such as</dt><dd><p><code class="docutils literal notranslate"><span class="pre">vector</span></code> or <code class="docutils literal notranslate"><span class="pre">string</span></code>. When used alone, this meta-variable doesn’t have much sense, it
is meant to be used in <a class="reference internal" href="#generic-class-constraints"><span class="std std-ref">Generic class constraints</span></a> to ensure that under-constrained
container classes have enough space allocated to add elements without needing to re-allocate
additional space.</p>
<p>We want to avoid memory re-allocation within complex objects because memory allocation
using symbolic pointers or sizes is likely to break under-constrained Manticore</p>
<p>An example usage of <code class="docutils literal notranslate"><span class="pre">$CAPACITY()</span></code> can be found in our <a class="reference internal" href="#generic-class-constraints"><span class="std std-ref">Generic class constraints</span></a>
<code class="docutils literal notranslate"><span class="pre">vector</span></code> reference example.</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">$SIZE(&lt;var&gt;)</span></code>: size is similar to <code class="docutils literal notranslate"><span class="pre">$CAPACITY</span></code> in so far as it refers to the current size
of a container-class. It should be contained between <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">$CAPACITY(&lt;var&gt;)</span></code>. Again,
using <code class="docutils literal notranslate"><span class="pre">$SIZE()</span></code> standalone doesn’t make sense, but it comes in handy for writing
generic class constraints.</p></li>
</ul>
<p>Example constraints to make the following structure coherent:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">buffer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="c1">// Current number of elements stored in &#39;buf&#39;</span>
<span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buffer</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$LEN(b.buf) == $CAPACITY(b)   # total length of b.buf: as big as b&#39;s capacity
$SIZE(b) &lt;= $CAPACITY(b) # current size of b less or equal to it&#39;s capacity
b.len == $SIZE(b)
</pre></div>
</div>
</div>
<div class="section" id="points-within-constraints">
<h3><code class="docutils literal notranslate"><span class="pre">$POINTS_WITHIN</span></code> constraints<a class="headerlink" href="#points-within-constraints" title="Permalink to this headline">¶</a></h3>
<p>By default, under-constrained Manticore will create new symbolic objects for every
symbolic pointer it deals with. For example, if running the <code class="docutils literal notranslate"><span class="pre">foo(int</span> <span class="pre">*a,</span> <span class="pre">int</span> <span class="pre">*b)</span></code>
function, Manticore will create two symbolic arrays, one for <code class="docutils literal notranslate"><span class="pre">a</span></code> and one for <code class="docutils literal notranslate"><span class="pre">b</span></code>.
Those are distinct and will never overlap.</p>
<p>In some cases, pointers actually point to the same memory area. For example that is the case
in <code class="docutils literal notranslate"><span class="pre">std::vector</span></code>’s implementation where the internal storage beginning and end are both
indicated by a raw pointer.</p>
<p>To tell Manticore that two pointers point to the same area, we can use the <code class="docutils literal notranslate"><span class="pre">$POINTS_WITHIN</span></code>
operator. The following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$POINTS_WITHIN(a,b)
</pre></div>
</div>
<p>will lead to Manticore creating one symbolic array for <code class="docutils literal notranslate"><span class="pre">a</span></code> and make <code class="docutils literal notranslate"><span class="pre">b</span></code> point to somewhere
within <code class="docutils literal notranslate"><span class="pre">a</span></code>.</p>
</div>
<div class="section" id="generic-class-constraints">
<span id="id2"></span><h3>Generic class constraints<a class="headerlink" href="#generic-class-constraints" title="Permalink to this headline">¶</a></h3>
<p>Symbolic constraints that must apply to all symbolic instances of a given type or class
can be written using the following syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">class_name</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">constraint</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;class_name&gt;:</span></code> specifier must match type names as they are stored in the CPG.</p>
<p>Since class constraints are generic, there is no declared variable name to use when
writing the constraint. Instead, one can use the <code class="docutils literal notranslate"><span class="pre">$OBJ.</span></code> syntax to refer to the
instance of the class. If we build up on our previous example, that would give:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">buffer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="c1">// Current number of elements stored in &#39;buf&#39;</span>
<span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">buffer</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>buffer: $LEN($OBJ.buf) == $CAPACITY($OBJ)   # total length of &#39;buf&#39; field as big as the instance capacity
buffer: $SIZE($OBJ) &lt;= $CAPACITY($OBJ) # current size of the instance less or equal to it&#39;s capacity
buffer: $OBJ.len == $SIZE($OBJ)
</pre></div>
</div>
<p>When under-constrained Manticore instantiates the function argument <code class="docutils literal notranslate"><span class="pre">b</span></code>, the generic
constraints for <code class="docutils literal notranslate"><span class="pre">buffer</span></code> are applied to <code class="docutils literal notranslate"><span class="pre">b</span></code> (<code class="docutils literal notranslate"><span class="pre">$OBJ</span></code> gets replaced by <code class="docutils literal notranslate"><span class="pre">b</span></code>).</p>
<p>It is also possible to write generic constraints for templated types by replace template
type arguments by <code class="docutils literal notranslate"><span class="pre">#</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">some_templated_class</span><span class="o">&lt;</span><span class="c1">#,#&gt;: ...</span>
</pre></div>
</div>
<p>In the constraint body, template arguments can be referred to with the <code class="docutils literal notranslate"><span class="pre">#&lt;num&gt;</span></code> syntax.
<code class="docutils literal notranslate"><span class="pre">#0</span></code> refers to the first template argument, <code class="docutils literal notranslate"><span class="pre">#1</span></code> to the second, and so on. Template arguments
references with <code class="docutils literal notranslate"><span class="pre">#</span></code> can be used in constraints by the following operators:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$TYPESIZE(#&lt;num&gt;)</span></code>: returns the size in bytes for template argument number <code class="docutils literal notranslate"><span class="pre">&lt;num&gt;</span></code>, starting at <code class="docutils literal notranslate"><span class="pre">#0</span></code></p></li>
</ul>
<p>Below is an example set of constraints that enforces correct behavior for a symbolic <code class="docutils literal notranslate"><span class="pre">std::vector</span></code>
with maximal capacity of 100 elements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Internal correctness of the data structure</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="c1">#,#&gt;: $OBJ._M_impl._M_finish - $OBJ._M_impl._M_start == $SIZE($OBJ)*$TYPESIZE(#0)</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="c1">#,#&gt;: $OBJ._M_impl._M_end_of_storage == $OBJ._M_impl._M_start + ($CAPACITY($OBJ)*$TYPESIZE(#0))</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="c1">#,#&gt;: $LEN($OBJ._M_impl._M_start) == $CAPACITY($OBJ)</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="c1">#,#&gt;: $CAPACITY($OBJ) == 100</span>
<span class="c1"># Make all internal pointers point to the same symbolic buffer</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="c1">#,#&gt;: $POINTS_WITHIN($OBJ._M_impl._M_finish, $OBJ._M_impl._M_start)</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="c1">#,#&gt;: $POINTS_WITHIN($OBJ._M_impl._M_end_of_storage, $OBJ._M_impl._M_start)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="state-forking">
<span id="forking"></span><h2>State forking<a class="headerlink" href="#state-forking" title="Permalink to this headline">¶</a></h2>
<p>Under-constrained Manticore will fork at the same locations as regular Manticore.
However, for practical reasons, under-constrained Manticore also needs to perform
additional forking on <a class="reference internal" href="#meta-variables"><span class="std std-ref">Meta-variables</span></a>. It will thus fork on:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$LEN</span></code>: the length of an array pointed by a symbolic pointer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$CAPACITY</span></code>: the capacity of a symbolic container class instance</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$SIZE</span></code>: the size (number of current elements) of a symbolic container class instance</p></li>
</ul>
<p>If desired it is possible to constrain some of the meta-variables further to avoid
too much state forking by  <a class="reference internal" href="#constraints-dsl"><span class="std std-ref">Specifying additional symbolic constraints</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="usagefinder.html" class="btn btn-neutral float-right" title="UsageFinder" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="trace.html" class="btn btn-neutral float-left" title="Traces" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019-2022, The MATE Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>